#!/usr/bin/env sh

# AI-related patterns to block (case-insensitive)
AI_PATTERNS="claude|sonnet|opus|anthropic|openai|chatgpt|gpt-4|gpt-3|copilot|codex|gemini|bard"

# Get author and committer info
AUTHOR_NAME="${GIT_AUTHOR_NAME:-$(git config user.name)}"
AUTHOR_EMAIL="${GIT_AUTHOR_EMAIL:-$(git config user.email)}"
COMMITTER_NAME="${GIT_COMMITTER_NAME:-$(git config user.name)}"
COMMITTER_EMAIL="${GIT_COMMITTER_EMAIL:-$(git config user.email)}"

# Check author
if echo "$AUTHOR_NAME $AUTHOR_EMAIL" | grep -qiE "$AI_PATTERNS"; then
  echo "❌ ERROR: AI-related author detected!"
  echo ""
  echo "Author: $AUTHOR_NAME <$AUTHOR_EMAIL>"
  echo ""
  echo "This repository does not allow AI attribution in commits."
  echo "Please set a human author using:"
  echo "  git commit --author=\"Your Name <your.email@example.com>\""
  echo ""
  exit 1
fi

# Check committer
if echo "$COMMITTER_NAME $COMMITTER_EMAIL" | grep -qiE "$AI_PATTERNS"; then
  echo "❌ ERROR: AI-related committer detected!"
  echo ""
  echo "Committer: $COMMITTER_NAME <$COMMITTER_EMAIL>"
  echo ""
  echo "This repository does not allow AI attribution in commits."
  echo "Please set human committer using environment variables:"
  echo "  GIT_COMMITTER_NAME=\"Your Name\" GIT_COMMITTER_EMAIL=\"your.email@example.com\" git commit ..."
  echo ""
  exit 1
fi

# Check commit message subject (first line)
SUBJECT=$(head -n 1 "$1")
if echo "$SUBJECT" | grep -qiE "$AI_PATTERNS"; then
  echo "❌ ERROR: AI-related text detected in commit subject!"
  echo ""
  echo "Subject: $SUBJECT"
  echo ""
  echo "This repository does not allow AI attribution in commits."
  echo "Please edit your commit message to remove AI references."
  echo ""
  exit 1
fi

# Check for Co-Authored-By with AI
if grep -qiE "Co-Authored-By:.*($AI_PATTERNS)" "$1"; then
  echo "❌ ERROR: AI co-authorship detected in commit message!"
  echo ""
  echo "This repository does not allow AI attribution in commits."
  echo "Please remove any 'Co-Authored-By' lines mentioning AI assistants."
  echo ""
  exit 1
fi
